<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-rc.4/css/uikit.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-rc.4/js/uikit.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-rc.4/js/uikit-icons.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/solarized-light.min.css" />
  <script defer src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/java.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
</head>
<body class="uk-background-muted">


  <style>
    
    

body
{
  font-family: "Open Sans", "Helvetica", "Helvetica Neue",  "Arial", sans-serif;
}

figcaption
{
  margin-bottom: 20px;
}

.vertical-align
{
  display: flex;
  align-items: center;
}

.ui.segment.pushable
{
  margin: 0;
  padding: 1rem 0;
  overflow: visible;
}

code
{
  font-family: "Monaco";
  font-size: 110%;
}

img
{
  padding:1px;
  border:1px solid black;
}

h1
{
  font-style:italic;
  font-size:130%;
  border-bottom:thin solid black;
}

h2
{
  font-size:110%;
  border-bottom: thin solid black;
}

h3
{
  font-size:100%;
  border-bottom: thin solid black;
}

body
{
  overflow-y: scroll;
}

.pushable > .pusher
{
  padding-bottom: 1.5rem;
}

.ui.segment.pushable
{
  margin: 0;
  padding: 1rem 0;
  overflow: visible;
}



  </style>

  <div uk-sticky>
    <nav class="uk-navbar-container" uk-navbar>
      <div class="uk-subnav-left">
        <ul class="uk-background-secondary uk-subnav-pill uk-subnav-divider">
          <li class="uk-active"><a href="../index.html">6: Sessions </a></li>
        </ul>
      </div>
      <div class="uk-navbar-right">
        <ul class="uk-subnav uk-background-secondary uk-subnav-pill uk-subnav-divider" uk-switcher="connect: .switcher-container">
          
            <li><a href="#">Lab-7 Playlist 4</a></li>
          
            <li><a href="#">Lab-7 Sessions</a></li>
          
            <li><a href="#">Exercise Solutions</a></li>
          
            <li><a href="#">02</a></li>
          
            <li><a href="#">03</a></li>
          
            <li><a href="#">04</a></li>
          
            <li><a href="#">05</a></li>
          
            <li><a href="#">06</a></li>
          
            <li><a href="#">07</a></li>
          
            <li><a href="#">Exercises</a></li>
          
        </ul>
      </div>
    </nav>
  </div>
  <div class="uk-container uk-container-expand">
    <ul class="uk-switcher switcher-container">
      
        <li> <h1>Objectives</h1>
<p>Introduce Sessions onto the Playlist application, enabling user accounts and cookie-based authentication.</p>
</li>
      
        <li> <h1>Objectives</h1>
<p>Introduce Sessions onto the Playlist application, enabling user accounts and cookie-based authentication.</p>
</li>
      
        <li> <h1>Exercises Solutions</h1>
<p>This lab requires that the <code>playlist-3</code> lab be completed. If you have lost your solution, create a new project in Gomix and select the <code>import from github</code> option and enter <code>wit-hdip-comp-sci-2018/playlist-3</code> to import a completed version.</p>
<h2>Exercise 1: Display Durations</h2>
<p>Make sure the duration of each song and playlist is visible on the UX</p>
<h3>views/partials/listsongs.hbs</h3>
<pre><code>&lt;table class=&quot;ui table&quot;&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;Song&lt;/th&gt;
      &lt;th&gt;Artist&lt;/th&gt;
      &lt;th&gt;Duration&lt;/th&gt;
      &lt;th&gt;&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    {{#each playlist.songs}}
      &lt;tr&gt;
        &lt;td&gt;
          {{title}}
        &lt;/td&gt;
        &lt;td&gt;
          {{artist}}
        &lt;/td&gt;
        &lt;td&gt;
          {{duration}}
        &lt;/td&gt;
        &lt;td&gt;
          &lt;a href=&quot;/playlist/{{../playlist.id}}/deletesong/{{id}}&quot; class=&quot;ui icon button&quot;&gt;
            &lt;i class=&quot;icon trash&quot;&gt;&lt;/i&gt;
          &lt;/a&gt;
        &lt;/td&gt;
      &lt;/tr&gt;
    {{/each}}
  &lt;/tbody&gt;
&lt;/table&gt;</code></pre>
<h2>Exercise 2: Add Song Duration</h2>
<p>Modify the add song form to accept a song duration as well as title and artist:</p>
<h2>views/partials/addsong.hbs</h2>
<pre><code>&lt;form class=&quot;ui stacked segment form&quot; action=&quot;/playlist/{{playlist.id}}/addsong&quot; method=&quot;POST&quot;&gt;
  &lt;div class=&quot;two fields&quot;&gt;
    &lt;div class=&quot;field&quot;&gt;
      &lt;label&gt;Title&lt;/label&gt;
      &lt;input placeholder=&quot;Title&quot; type=&quot;text&quot; name=&quot;title&quot;&gt;
    &lt;/div&gt;
    &lt;div class=&quot;field&quot;&gt;
      &lt;label&gt;Artist&lt;/label&gt;
      &lt;input placeholder=&quot;Artist&quot; type=&quot;text&quot; name=&quot;artist&quot;&gt;
    &lt;/div&gt;
    &lt;div class=&quot;field&quot;&gt;
      &lt;label&gt;Duration&lt;/label&gt;
      &lt;input placeholder=&quot;00&quot; type=&quot;number&quot; name=&quot;duration&quot;&gt;
    &lt;/div&gt;
  &lt;/div&gt;
  &lt;button class=&quot;ui blue submit button&quot;&gt;Add Song&lt;/button&gt;
&lt;/form&gt;</code></pre>
<h2>controllers/playlist.js</h2>
<pre><code>    const newSong = {
      id: uuid(),
      title: request.body.title,
      artist: request.body.artist,
      duration: Number(request.body.duration),
    };</code></pre>
<h2>Exercise 3: Active Duration</h2>
<p>The durations in each playlist are just constants stored in the database. Currently, if you add a new playlist + songs, then the duration in the playlist will be undefined.</p>
<p>Change this now, such that when you add a song to a playlist the duration displayed on the dashboard for each playlist will be the actual sum of the donations for all songs in the playlist.</p>
<pre><code>...
  addSong(id, song) {
    const playlist = this.getPlaylist(id);
    playlist.songs.push(song);

    let duration = 0;
    for (let i = 0; i &lt; playlist.songs.length; i++) {
      duration += playlist.songs[i].duration;
    }

    playlist.duration = duration;
    this.store.save();
  },
...</code></pre>
</li>
      
        <li> <h1>Playlist Model</h1>
<p>This lab is based on Playlist-3. This can be imported into a new gomix project from <code>/wit-ict-summer-school-2017/playlist-3</code>.</p>
<h2>models/playlist-store.js</h2>
<p>If your project has any playlists in the json store, delete them now. Your store should look like this:</p>
<h2>models/playlist-store.json</h2>
<pre><code>{
  &quot;playlistCollection&quot;: [
  ]
}</code></pre>
<p>We need a new method in the playlist-store module, which will retrieve a playlist based on a specific user id.</p>
<h2>models/playlist-store.js</h2>
<pre><code>...
  getUserPlaylists(userid) {
    return this.store.findBy(this.collection, { userid: userid });
  },
...</code></pre>
<p>This new methods takes a userid, and will only fetch playlists belonging to the user with the specific id. We havent introduced the User model yet - nor are we storing playlists with such an id. We will make these changes in this lab.</p>
</li>
      
        <li> <h1>UserStore</h1>
<p>Now we can introduce a new model:</p>
<h2>models/user-store.js</h2>
<pre><code>&#39;use strict&#39;;

const _ = require(&#39;lodash&#39;);
const JsonStore = require(&#39;./json-store&#39;);

const userStore = {

  store: new JsonStore(&#39;./models/user-store.json&#39;, { users: [] }),
  collection: &#39;users&#39;,

  getAllUsers() {
    return this.store.findAll(this.collection);
  },

  addUser(user) {
    this.store.add(this.collection, user);
  },

  getUserById(id) {
    return this.store.findOneBy(this.collection, { id: id });
  },

  getUserByEmail(email) {
    return this.store.findOneBy(this.collection, { email: email });
  },
};

module.exports = userStore;</code></pre>
<p>And this is a pre-populated model store:
us</p>
<h2>models/user-store.json</h2>
<pre><code>{
  &quot;users&quot;: [
    {
      &quot;firstName&quot;: &quot;homer&quot;,
      &quot;lastName&quot;: &quot;simpson&quot;,
      &quot;email&quot;: &quot;homer@simpson.com&quot;,
      &quot;password&quot;: &quot;secret&quot;,
      &quot;id&quot;: &quot;3ad52697-6d98-4d80-8273-084de55a86c0&quot;
    },
    {
      &quot;firstName&quot;: &quot;marge&quot;,
      &quot;lastName&quot;: &quot;simpson&quot;,
      &quot;email&quot;: &quot;marge@simpson.com&quot;,
      &quot;password&quot;: &quot;secret&quot;,
      &quot;id&quot;: &quot;2b6f0989-7b7f-4a38-ad26-aa06b922d751&quot;
    }
  ]
}</code></pre>
<p>In the above we are pre-loading two users for test purposes.</p>
</li>
      
        <li> <h1>Accounts views</h1>
<p>We need a suite of new views to support signup / login</p>
<h2>views/index.hbs</h2>
<pre><code>{{&gt; welcomemenu }}

&lt;section class=&quot;ui center aligned middle aligned segment&quot;&gt;
  &lt;p&gt; Sign up or Log in... &lt;/p&gt;
&lt;/section&gt;</code></pre>
<h2>views/login.hbs</h2>
<pre><code>{{&gt; welcomemenu id=&#39;login&#39; }}

&lt;form class=&quot;ui stacked segment form&quot; action=&quot;/authenticate&quot; method=&quot;POST&quot;&gt;
  &lt;h3 class=&quot;ui header&quot;&gt;Log-in&lt;/h3&gt;
  &lt;div class=&quot;field&quot;&gt;
    &lt;label&gt;Email&lt;/label&gt; &lt;input placeholder=&quot;Email&quot; name=&quot;email&quot;&gt;
  &lt;/div&gt;
  &lt;div class=&quot;field&quot;&gt;
    &lt;label&gt;Password&lt;/label&gt; &lt;input type=&quot;password&quot;  name=&quot;password&quot;&gt;
  &lt;/div&gt;
  &lt;button class=&quot;ui blue submit button&quot;&gt;Login&lt;/button&gt;
&lt;/form&gt;</code></pre>
<h2>views/signup.hbs</h2>
<pre><code>{{&gt; welcomemenu id=&quot;signup&quot;}}

&lt;form class=&quot;ui stacked segment form&quot; action=&quot;/register&quot; method=&quot;POST&quot;&gt;
  &lt;h3 class=&quot;ui header&quot;&gt;Register&lt;/h3&gt;
  &lt;div class=&quot;two fields&quot;&gt;
    &lt;div class=&quot;field&quot;&gt;
      &lt;label&gt;First Name&lt;/label&gt;
      &lt;input placeholder=&quot;First Name&quot; type=&quot;text&quot;  name=&quot;firstName&quot;&gt;
    &lt;/div&gt;
    &lt;div class=&quot;field&quot;&gt;
      &lt;label&gt;Last Name&lt;/label&gt;
      &lt;input placeholder=&quot;Last Name&quot; type=&quot;text&quot;  name=&quot;lastName&quot;&gt;
    &lt;/div&gt;
  &lt;/div&gt;
  &lt;div class=&quot;field&quot;&gt;
    &lt;label&gt;Email&lt;/label&gt;
    &lt;input placeholder=&quot;Email&quot; type=&quot;text&quot; name=&quot;email&quot;&gt;
  &lt;/div&gt;
  &lt;div class=&quot;field&quot;&gt;
    &lt;label&gt;Password&lt;/label&gt;
    &lt;input type=&quot;password&quot; name=&quot;password&quot;&gt;
  &lt;/div&gt;
  &lt;button class=&quot;ui blue submit button&quot;&gt;Submit&lt;/button&gt;
&lt;/form&gt;</code></pre>
<p>In addition, a new menu which will support the above views:</p>
<h2>views/partials/welcomemenu.hbs</h2>
<pre><code>&lt;nav class=&quot;ui menu&quot;&gt;
  &lt;header class=&quot;ui header item&quot;&gt; &lt;a href=&quot;/&quot;&gt; Playlist 4 &lt;/a&gt;&lt;/header&gt;
  &lt;div class=&quot;right menu&quot;&gt;
    &lt;a id=&quot;signup&quot; class=&quot;item&quot; href=&quot;/signup&quot;&gt; Signup  &lt;/a&gt;
    &lt;a id=&quot;login&quot; class=&quot;item&quot; href=&quot;/login&quot;&gt;  Login   &lt;/a&gt;
  &lt;/div&gt;
&lt;/nav&gt;

&lt;script&gt;
  $(&quot;#{{id}}&quot;).addClass(&quot;active item&quot;);
&lt;/script&gt;</code></pre>
<p>And finally, we need to extend the menu partial - which will introduce a new menu option to allow a user to log out:</p>
<h2>views/partials/menu.hbs</h2>
<pre><code>&lt;nav class=&quot;ui menu&quot;&gt;
  &lt;header class=&quot;ui header item&quot;&gt; &lt;a href=&quot;/&quot;&gt; Playlist 4 &lt;/a&gt;&lt;/header&gt;
  &lt;div class=&quot;right menu&quot;&gt;
    &lt;a id=&quot;dashboard&quot; class=&quot;item&quot; href=&quot;/dashboard&quot;&gt; Dashboard  &lt;/a&gt;
    &lt;a id=&quot;about&quot; class=&quot;item&quot; href=&quot;/about&quot;&gt; About &lt;/a&gt;
    &lt;a id=&quot;logout&quot; class=&quot;item&quot; href=&quot;/logout&quot;&gt; Logout &lt;/a&gt;
  &lt;/div&gt;
&lt;/nav&gt;

&lt;script&gt;
  $(&quot;#{{id}}&quot;).addClass(&quot;active item&quot;);
&lt;/script&gt;</code></pre>
</li>
      
        <li> <p>accounts.# Accounts controller</p>
<p>This is a new controller to support these views:</p>
<h2>controllers/accounts</h2>
<pre><code>&#39;use strict&#39;;

const userstore = require(&#39;../models/user-store&#39;);
const logger = require(&#39;../utils/logger&#39;);
const uuid = require(&#39;uuid&#39;);

const accounts = {

  index(request, response) {
    const viewData = {
      title: &#39;Login or Signup&#39;,
    };
    response.render(&#39;index&#39;, viewData);
  },

  login(request, response) {
    const viewData = {
      title: &#39;Login to the Service&#39;,
    };
    response.render(&#39;login&#39;, viewData);
  },

  logout(request, response) {
    response.cookie(&#39;playlist&#39;, &#39;&#39;);
    response.redirect(&#39;/&#39;);
  },

  signup(request, response) {
    const viewData = {
      title: &#39;Login to the Service&#39;,
    };
    response.render(&#39;signup&#39;, viewData);
  },

  register(request, response) {
    const user = request.body;
    user.id = uuid();
    userstore.addUser(user);
    logger.info(`registering ${user.email}`);
    response.redirect(&#39;/&#39;);
  },

  authenticate(request, response) {
    const user = userstore.getUserByEmail(request.body.email);
    if (user) {
      response.cookie(&#39;playlist&#39;, user.email);
      logger.info(`logging in ${user.email}`);
      response.redirect(&#39;/dashboard&#39;);
    } else {
      response.redirect(&#39;/login&#39;);
    }
  },

  getCurrentUser(request) {
    const userEmail = request.cookies.playlist;
    return userstore.getUserByEmail(userEmail);
  },
};

module.exports = accounts;</code></pre>
</li>
      
        <li> <h1>Routes</h1>
<p>These new views+ controller  all require new routes:</p>
<h2>routes.js</h2>
<p>In particular, these specific routes:</p>
<pre><code>
...
const accounts = require(&#39;./controllers/accounts.js&#39;);
...

...
router.get(&#39;/&#39;, accounts.index);
router.get(&#39;/login&#39;, accounts.login);
router.get(&#39;/signup&#39;, accounts.signup);
router.get(&#39;/logout&#39;, accounts.logout);
router.post(&#39;/register&#39;, accounts.register);
router.post(&#39;/authenticate&#39;, accounts.authenticate);
...</code></pre>
<p>This is the complete revised routes.js</p>
<pre><code>&#39;use strict&#39;;

const express = require(&#39;express&#39;);
const router = express.Router();

const dashboard = require(&#39;./controllers/dashboard.js&#39;);
const about = require(&#39;./controllers/about.js&#39;);
const playlist = require(&#39;./controllers/playlist.js&#39;);

router.get(&#39;/&#39;, accounts.index);
router.get(&#39;/login&#39;, accounts.login);
router.get(&#39;/signup&#39;, accounts.signup);
router.get(&#39;/logout&#39;, accounts.logout);
router.post(&#39;/register&#39;, accounts.register);
router.post(&#39;/authenticate&#39;, accounts.authenticate);

router.get(&#39;/dashboard&#39;, dashboard.index);
router.get(&#39;/dashboard/deleteplaylist/:id&#39;, dashboard.deletePlaylist);
router.post(&#39;/dashboard/addplaylist&#39;, dashboard.addPlaylist);

router.get(&#39;/about&#39;, about.index);
router.get(&#39;/playlist/:id&#39;, playlist.index);
router.get(&#39;/playlist/:id/deletesong/:songid&#39;, playlist.deleteSong);
router.post(&#39;/playlist/:id/addsong&#39;, playlist.addSong);

module.exports = router;</code></pre>
<p>The application should be running now. You should see these new views:</p>
<h3>A new landing page</h3>
<p><img src="img/02.png" alt=""></p>
<h3>Signup</h3>
<p><img src="img/01.png" alt=""></p>
<h3>login</h3>
<p><img src="img/03.png" alt=""></p>
</li>
      
        <li> <h1>Dashboard</h1>
<p>Try the following now:</p>
<ul>
<li>Log in as &#39;homer@simpson&#39;, &#39;secret&#39;. </li>
<li>Add a playlist called &#39;test&#39;.</li>
<li>logout</li>
<li>Log in as &#39;marge@simpson&#39;, &#39;secret&#39;. </li>
</ul>
<p>Notice that we are seeing Homers test playlist even when we log in as marge? The playlist-store.json may look like this:</p>
<pre><code>{
  &quot;playlistCollection&quot;: [
    {
      &quot;id&quot;: &quot;4a1ea4ec-303e-4b13-bd98-a6b04877e093&quot;,
      &quot;title&quot;: &quot;test&quot;,
      &quot;songs&quot;: []
    }
  ]
}</code></pre>
<p>(you will need to refresh the Glitch Editor view to see the above change)</p>
<p>This clearly is not what we were aiming for. We should only present the users own play lists.</p>
<p>Here is how do it - all changes to the dashboard module:</p>
<h2>controller/dashboard.js</h2>
<p>In the top of the module, import the new accounts module:</p>
<pre><code>...
const accounts = require (&#39;./accounts.js&#39;);
...</code></pre>
<p>Revised index action:</p>
<pre><code>...
  index(request, response) {
    logger.info(&#39;dashboard rendering&#39;);
    const loggedInUser = accounts.getCurrentUser(request);
    const viewData = {
      title: &#39;Playlist Dashboard&#39;,
      playlists: playlistStore.getUserPlaylists(loggedInUser.id),
    };
    logger.info(&#39;about to render&#39;, playlistStore.getAllPlaylists());
    response.render(&#39;dashboard&#39;, viewData);
  },
...</code></pre>
<p>Revised addPlaylist action:</p>
<pre><code>...
  addPlaylist(request, response) {
    const loggedInUser = accounts.getCurrentUser(request);
    const newPlayList = {
      id: uuid(),
      userid: loggedInUser.id,
      title: request.body.title,
      songs: [],
    };
    logger.debug(&#39;Creating a new Playlist&#39;, newPlayList);
    playlistStore.addPlaylist(newPlayList);
    response.redirect(&#39;/dashboard&#39;);
  },
...</code></pre>
<p>Log in again as marge and homer in turn, creating a single playlist (use a name you will remember). Make sure that the appropriate playlist appears in each users dashboard.</p>
<h2>The Stores</h2>
<p>Looking at the playlist-store.json - it might (eventually when loaded) look like this:</p>
<pre><code>{
  &quot;playlistCollection&quot;: [
    {
      &quot;id&quot;: &quot;4a1ea4ec-303e-4b13-bd98-a6b04877e093&quot;,
      &quot;title&quot;: &quot;test&quot;,
      &quot;songs&quot;: []
    },
    {
      &quot;id&quot;: &quot;1e6ed5a0-28fe-4527-8ce8-6cb5c800b5be&quot;,
      &quot;userid&quot;: &quot;2b6f0989-7b7f-4a38-ad26-aa06b922d751&quot;,
      &quot;title&quot;: &quot;marges playlist&quot;,
      &quot;songs&quot;: []
    },
    {
      &quot;id&quot;: &quot;07dd66fe-9f8f-456c-944d-48330bde4610&quot;,
      &quot;userid&quot;: &quot;3ad52697-6d98-4d80-8273-084de55a86c0&quot;,
      &quot;title&quot;: &quot;homers playlist&quot;,
      &quot;songs&quot;: []
    }
  ]
}</code></pre>
<p>Examine it carefully - notice that the very first playlist is &#39;orphaned&#39; - it has no userid. The others have userid - which corellates the playlists with the user in the users store:</p>
<pre><code>{
  &quot;users&quot;: [
    {
      &quot;firstName&quot;: &quot;homer&quot;,
      &quot;lastName&quot;: &quot;simpson&quot;,
      &quot;email&quot;: &quot;homer@simpson.com&quot;,
      &quot;password&quot;: &quot;secret&quot;,
      &quot;id&quot;: &quot;3ad52697-6d98-4d80-8273-084de55a86c0&quot;
    },
    {
      &quot;firstName&quot;: &quot;marge&quot;,
      &quot;lastName&quot;: &quot;simpson&quot;,
      &quot;email&quot;: &quot;marge@simpson.com&quot;,
      &quot;password&quot;: &quot;secret&quot;,
      &quot;id&quot;: &quot;2b6f0989-7b7f-4a38-ad26-aa06b922d751&quot;
    }
  ]
}</code></pre>
</li>
      
        <li> <h1>Exercise</h1>
<p>This is the completed archive at this stage:</p>
<ul>
<li><a href="https://github.com/wit-ict-summer-school-2017/playlist-4">https://github.com/wit-ict-summer-school-2017/playlist-4</a></li>
</ul>
<p>It can be imported into gomix using <code>wit-ict-summer-school-2017/playlist-4</code></p>
<h2>Exercise 1</h2>
<p>Test the application more comprehensively - signing up a range of users, and creating playlists. Make sure the users only see the playlists they have created.</p>
<h2>Exercise 2</h2>
<p>Look at the <code>authenticate</code> method again:</p>
<pre><code>  authenticate(request, response) {
    const user = userstore.getUserByEmail(request.body.email);
    if (user) {
      response.cookie(&#39;playlist&#39;, user.email);
      logger.info(`logging in ${user.email}`);
      response.redirect(&#39;/dashboard&#39;);
    } else {
      response.redirect(&#39;/login&#39;);
    }
  },</code></pre>
<p>Can you see anything not quite right about it? </p>
<p>Hint: what happens if incorrect password entered? Try this now.</p>
<p>See if you can fix this problem - i.e. only allow user to log in if they provide correct password.</p>
</li>
      
    </ul>
  </div>

</body>
</html>